"""
Tiny Flask app to demonstrate stored/reflected XSS in a local-only page.

* This app only listens on 127.0.0.1 (if run) and has debug disabled by default.
* It includes a vulnerable template rendering route (VULN) and a safe-escaped route (SAFE).
* Do not run on public networks.
"""

from flask import Flask, request, render_template_string

app = Flask(__name__)
app.config['TESTING'] = True  # keep safe defaults
# DO NOT enable debug in public or production
app.config['DEBUG'] = False

VULN_TEMPLATE = """
<!doctype html>
<title>Notes (VULN)</title>
<h1>Notes (vulnerable view)</h1>
<p>Note content:</p>
<div id="note">{{ content | safe }}</div>
"""

SAFE_TEMPLATE = """
<!doctype html>
<title>Notes (SAFE)</title>
<h1>Notes (safe view)</h1>
<p>Note content:</p>
<div id="note">{{ content }}</div>
"""

# Stored notes (in-memory)
NOTES = {"1": "Welcome note"}


@app.route("/note/<id>/vuln", methods=["GET", "POST"])
def note_vuln(id):
    if request.method == "POST":
        # VULN: store raw content (simulating a stored XSS scenario)
        NOTES[id] = request.form.get("content", "")
    content = NOTES.get(id, "")
    # Vulnerable rendering uses |safe and will not escape HTML
    return render_template_string(VULN_TEMPLATE, content=content)


@app.route("/note/<id>/safe", methods=["GET", "POST"])
def note_safe(id):
    if request.method == "POST":
        # store raw content (safe rendering escapes it)
        NOTES[id] = request.form.get("content", "")
    content = NOTES.get(id, "")
    return render_template_string(SAFE_TEMPLATE, content=content)


def run(safe_mode=True):
    print("Flask XSS demo (LOCAL ONLY).")
    print("By default this demo does not auto-run the server. To run manually use:")
    print("  python -m flask --app scenarios.xss_flask.run runserver --host=127.0.0.1 --port=5001")
    print("\nRoutes:")
    print("  GET/POST /note/<id>/vuln  - vulnerable rendering (shows why unescaped HTML is bad)")
    print("  GET/POST /note/<id>/safe  - safe rendering (Jinja auto-escapes)")
    print("\nNote: do not run on 0.0.0.0 or with debug enabled.")
